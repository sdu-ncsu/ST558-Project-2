---
title: "Bicycle Analysis"
author: "Todd Idol"
date: "10/10/2020"
output: 
   github_document:
    toc: true
    toc_depth: 2
params:
  day: 1
---


```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE)
rmarkdown::find_pandoc(version = '2.10.1')
options(knitr.duplicate.label = "allow")
library(tidyverse)
library(rmarkdown)
library(knitr)
library(caret)
library(dplyr)
library(data.table)
```

# Project Repo

Find the project repo [here](https://github.com/tkidol/ST558-Project-2).

# Weekly Analysis 

+  The analysis for [Sunday is available here](SundayAnalysis.md).  

+  The analysis for [Monday is available here](MondayAnalysis.md).  

+  The analysis for [Tuesday is available here](TuesdayAnalysis.md).  

+  The analysis for [Wednesday is available here](Wedesdaynalysis.md).  

+ The analysis for [Thursday is available here](ThursdayAnalysis.md).  

+ The analysis for [Friday is available here](FridayAnalysis.md).  

+  The analysis for [Saturday is available here](SaturdayAnalysis.md).

# Packages

## Tidyverse

The workhorse of this project for 3 main core packages: DPLYR - manipulated all of my data (selects, joins, filter, new variables... ), Tibble for rendering Data Frames more effectively, & () ggplot2 for discrete & continuous data plots

## Rmarkdown 

Key to the project for the Rmd file itself including the knitr:: functions for consumable object output (kable) & README.md github doc output through render()

## Caret

Used to create standardized train/test data & create controls and tuning for LM & GLM analysis

# Set Parameters & Knit

# Introduction

You should have an introduction section that briefly describes the data and the variables you have to work
with (no need to discuss all of them, just the ones you want to use). If you are analyzing the bike share
data, do not use the casual and registered variables to do any modeling!
You should also mention the purpose of your analysis and the methods youâ€™ll use (no need to detail them
here) for analysis.

# Data

```{r, data}

bikeData <- read.csv("hour.csv")

# removing casual & registered vars since they will not be used for modeling
bikeData <- bikeData  %>% select(everything(), -c("casual", "registered")) %>% mutate(weekday = as.factor(weekday))

# filtering for individual weekday reporting
bikeData <- bikeData  %>% filter(weekday == params$day)

# split data 70% train & 80% test
set.seed(100)
trainIndex <- createDataPartition(bikeData$cnt, p = .7, list = FALSE)

bikeTrain <- bikeData[trainIndex, ]
bikeTest <- bikeData[-trainIndex, ]
```
# Summarizations

```{r, summaries}

sumBikeTrain <- bikeTrain %>% select(dteday, season, hr, workingday, weathersit, temp, hum, windspeed, cnt)

# create factors for season, timeofday and weather
sumBikeTrain <- mutate(sumBikeTrain, workday = as.factor(ifelse(sumBikeTrain$workingday == 0, "no", "yes")),
                       
                                     season = as.factor(ifelse(sumBikeTrain$season == 1, "winter",
                                                        ifelse(sumBikeTrain$season == 2, "spring",
                                                        ifelse(sumBikeTrain$season == 3, "summer", "fall")
                                                       ))),
                       
                                     hour = as.factor(ifelse((sumBikeTrain$hr >= 6) & (sumBikeTrain$hr < 10), 
                                                            "AM commute", 
                                                      ifelse((sumBikeTrain$hr >= 10) & (sumBikeTrain$hr < 16),
                                                           "mid day", 
                                                      ifelse((sumBikeTrain$hr >= 16 )& (sumBikeTrain$hr < 20), 
                                                           "PM commute", 
                                                      ifelse((sumBikeTrain$hr >= 20) & (sumBikeTrain$hr <= 23),
                                                           "night", "late night")
                                                     )))),
                       
                                     weather = as.factor(ifelse(sumBikeTrain$weathersit == 1, "clear", 
                                                         ifelse(sumBikeTrain$weathersit == 2, "mist",
                                                         ifelse(sumBikeTrain$weathersit == 3, "light precip", 
                                                                                           "heavy precip")
                                                       ))))
                                  
# select new vars for analysis 
sumBikeTrain <- sumBikeTrain %>% select(dteday, season, weather, temp, hum, windspeed, workingday, hour, cnt) %>% 
                                 rename("humidity" = hum, "rentals" = cnt, "workday" = workingday)
head(filter(sumBikeTrain, hour == "late night"))


```

## Summaries for Season & Weather


```{r, sum mean wrapper}
sum_meanFx <- function(cat, ...) {
   if ((!is.null(cat) & (!is.character(cat)) & ((cat %in% sumBikeTrain[2]) |
                                                (cat %in% sumBikeTrain[3]) |
                                                (cat %in% sumBikeTrain[8]))))
    stop("invalid input")
                                                                     
   if (cat == "season") { 
     seasonSum_Mean <- sumBikeTrain %>% group_by(season) %>%
                                       mutate(rental_mean = round(mean(rentals),
                                                                 digits = 2), 
                                              rental_sum = round(sum(rentals),
                                                                digits = 2)) %>% 
                                       select(season, rental_mean, rental_sum)
     seasonSum_Mean <- as_tibble(unique(seasonSum_Mean))
     return(seasonSum_Mean)
     
   } else if (cat == "weather") {
      weatherSum_Mean <- sumBikeTrain %>% group_by(weather) %>%
                                         mutate(rental_mean = round(mean(rentals),
                                                                   digits = 2), 
                                                rental_sum = round(sum(rentals),
                                                                   digits = 2)) %>% 
                                         select(weather, rental_mean, rental_sum) 
      weatherSum_Mean <- as_tibble(unique(weatherSum_Mean))
      return(weatherSum_Mean)
       
   } else if (cat == "hour") {
      hourSum_Mean <- sumBikeTrain %>% group_by(hour) %>% 
                                       mutate(rental_mean = round(mean(rentals),
                                                                 digits = 2), 
                                              rental_sum = round(sum(rentals),
                                                                digits = 2)) %>% 
                                       select(hour, rental_mean, rental_sum)
       hourSum_Mean <- as_tibble(unique(hourSum_Mean))
       return(hourSum_Mean)
       
   } else {
       return(null)
   }
}
```


```{r, season statbox}
kable(sum_meanFx("season"), caption = "Rentals by Season")

seasonBox <- ggplot(sumBikeTrain, aes(x = rentals, y = season, color = season))
seasonBox + geom_boxplot() + labs(title = "Rentals by Season")
```




```{r, weather statbox}
kable(sum_meanFx("weather"), caption = "Rentals by Weather Condition")

weatherBox <- ggplot(sumBikeTrain, aes(x = rentals, y = weather, color = weather))
weatherBox + geom_boxplot() + labs(title = "Rentals by Weather Condiion")
```

```{r, hour statbox}
kable(sum_meanFx("hour"), caption = "Rentals by Hour")

hourBox <- ggplot(sumBikeTrain, aes(x = rentals, y = hour, color = hour))
hourBox + geom_boxplot() + labs(title = "Rentals by Hour")


dayOff <- sumBikeTrain %>% filter(workday == 0)
dayOffStat <- dayOff %>% group_by(hour) %>% mutate(rental_mean = round(mean(rentals),
                                                                        digits = 2), 
                                                    rental_sum = round(sum(rentals),
                                                                       digits = 2)) %>% 
                                                    select(hour, rental_mean, rental_sum)
dayOffStat <- as_tibble(unique(dayOffStat))
kable(dayOffStat, caption = "Rentals by Hour (Day Off")

dayOffBox <- ggplot(dayOff, aes(x = rentals, y = hour, color = hour))
dayOffBox + geom_boxplot() + labs(title = "Rentals by Hour (Day Off)")

dayOn <- sumBikeTrain %>% filter(workday == 1)
dayOnStat <- dayOn %>% group_by(hour) %>% mutate(rental_mean = round(mean(rentals),
                                                                      digits = 2), 
                                                  rental_sum = round(sum(rentals),
                                                                     digits = 2)) %>% 
                                                  select(hour, rental_mean, rental_sum)
dayOnStat <- as_tibble(unique(dayOnStat))
kable(dayOnStat, caption = "Rentals by Time of Day (Work Day)")

dayOnBox <- ggplot(dayOn, aes(x = rentals, y = hour, color = hour))
dayOnBox + geom_boxplot() + labs(title = "Rentals by Time of Day (Work Day)")


```

```{r, quantstats}
# 
quantStats <- sumBikeTrain %>% select(c(4, 5, 6, 9)) %>% apply(2, summary)

rentalCor <- select(sumBikeTrain, c(temp, humidity, windspeed, rentals))
rentalCor <- as.data.frame(round(cor(rentalCor), digits = 2))


kable(round((quantStats), 2), caption = "Summary: Quantitative Varibles")
kable(rentalCor, caption = "Rental Correlations")
```

```{r, temp plots}
# Base plot aesthetic with Total Points on x axis

tempPoint_season <- ggplot(sumBikeTrain, aes(x = temp, y = rentals, color = season))

# Avg PM point plot
tempPoint_season + geom_point() + geom_smooth(aes(group = season,), method = lm, col = "black") + 
            scale_fill_continuous() + labs(title =  "Season Rentals by Temperature") +
            facet_wrap(~ season)

tempPoint_weather <- ggplot(sumBikeTrain, aes(x = temp, y = rentals, color = weather))

tempPoint_weather + geom_point() + geom_smooth(aes(group = weather), method = lm, col = "black") + 
            scale_fill_continuous() + labs(title =  "Weather Rentals by Temperature") +
            facet_wrap(~ weather)

tempPoint_hour <- ggplot(sumBikeTrain, aes(x = temp, y = rentals, color = hour))

tempPoint_hour + geom_point() + geom_smooth(aes(group = hour), method = lm, col = "black") + 
            scale_fill_continuous() + labs(title =  "Time of Day Rentals by Temperature") +
            facet_wrap(~ hour)
```


```{r, humidity plots}
# Base plot aesthetic with Total Points on x axis

humPoint_season <- ggplot(sumBikeTrain, aes(x = humidity, y = rentals, color = season))

# Avg PM point plot
humPoint_season + geom_point() + geom_smooth(aes(group = season), method = lm, col = "black") + 
            scale_fill_continuous() + labs(title =  "Season Rentals by Humidity") +
            facet_wrap(~ season)

humPoint_weather <- ggplot(sumBikeTrain, aes(x = humidity, y = rentals, color = weather))

humPoint_weather + geom_point() + geom_smooth(aes(group = weather), method = lm, col = "black") + 
            scale_fill_continuous() + labs(title =  "Weather Rentals by Humidity") +
            facet_wrap(~ weather)

humPoint_hour <- ggplot(sumBikeTrain, aes(x = humidity, y = rentals, color = hour))

humPoint_hour + geom_point() + geom_smooth(aes(group = hour), method = lm, col = "black") + 
            scale_fill_continuous() + labs(title =  "Time of Day Rentals by Humidity") +
            facet_wrap(~ hour)
```

```{r, wind plots}

# Base plot aesthetic with Total Points on x axis

windPoint_season <- ggplot(sumBikeTrain, aes(x = windspeed, y = rentals, color = season))

# Avg PM point plot
windPoint_season + geom_point() + geom_smooth(aes(group = season), method = lm, col = "black") + 
            scale_fill_continuous() + labs(title =  "Season Rentals by Wind Speed") +
            facet_wrap(~ season)

windPoint_weather <- ggplot(sumBikeTrain, aes(x = windspeed, y = rentals, color = weather))

windPoint_weather + geom_point() + geom_smooth(aes(group = weather), method = lm, col = "black") + 
            scale_fill_continuous() + labs(title =  "Weather Rentals by Wind Speed") +
            facet_wrap(~ weather)

windPoint_hour <- ggplot(sumBikeTrain, aes(x = windspeed, y = rentals, color = hour))

windPoint_hour + geom_point() + geom_smooth(aes(group = hour), method = lm, col = "black") + 
            scale_fill_continuous() + labs(title =  "Time of Day Rentals by Wind Speed") +
            facet_wrap(~ hour)
```


# Modeling

words


### Post Summary Analysis Train & Test Data

```{r, modeling}

bikeTrain1 <- bikeTrain %>% select(c(season, hr, weathersit, temp, hum, cnt)) %>%
                            mutate(season = as.factor(ifelse(bikeTrain$season == 1, "winter",
                                                      ifelse(bikeTrain$season == 2, "spring",
                                                      ifelse(bikeTrain$season == 3, "summer", "fall")
                                                     ))),
                       
                            hour = as.factor(ifelse((bikeTrain$hr >= 6) & (bikeTrain$hr < 10), "AM commute", 
                                             ifelse((bikeTrain$hr >= 10) & (bikeTrain$hr < 16), "mid day", 
                                             ifelse((bikeTrain$hr >= 16 )& (bikeTrain$hr < 20), "PM commute", 
                                             ifelse((bikeTrain$hr >= 20) & (bikeTrain$hr <= 23), "night", "late night")
                                            )))),
                       
                            weather = as.factor(ifelse(bikeTrain$weathersit == 1, "clear", 
                                                ifelse(bikeTrain$weathersit == 2, "mist",
                                                ifelse(bikeTrain$weathersit == 3, "light precip", "heavy precip")
                                               )))) %>%
                            rename("humidity" = hum, "rentals" = cnt)
bikeTrain1 <- bikeTrain1 %>% select(c(season, hour, weather, temp, humidity, rentals))        
str(bikeTrain1)

bikeTest1 <- bikeTest %>% select(c(season, hr, weathersit, temp, hum, cnt)) %>%
                          mutate(season = as.factor(ifelse(bikeTest$season == 1, "winter",
                                                    ifelse(bikeTest$season == 2, "spring",
                                                    ifelse(bikeTest$season == 3, "summer", "fall")
                                                   ))),
                       
                          hour = as.factor(ifelse((bikeTest$hr >= 6) & (bikeTest$hr < 10), "AM commute", 
                                           ifelse((bikeTest$hr >= 10) & (bikeTest$hr < 16), "mid day", 
                                           ifelse((bikeTest$hr >= 16 )& (bikeTest$hr < 20), "PM commute", 
                                           ifelse((bikeTest$hr >= 20) & (bikeTest$hr <= 23), "night", "late night")
                                          )))),
                       
                         weather = as.factor(ifelse(bikeTest$weathersit == 1, "clear", 
                                             ifelse(bikeTest$weathersit == 2, "mist",
                                             ifelse(bikeTest$weathersit == 3, "light precip", "heavy precip")
                                            )))) %>%
                            rename("humidity" = hum, "rentals" = cnt)
bikeTest1 <- bikeTest1 %>% select(c(season, hour, weather, temp, humidity, rentals))        

str(bikeTest1)
```
## Tree Based Model (non-ensemble)

words


```{r, rtree all}
# train all predictors

rfit_all <- train(rentals ~ ., data = bikeTrain1,
                  method = "rpart", preProcess = 
                  c("center", "scale"), trControl = 
                  trainControl(method = "LOOCV"))
rfit_all$results

plot(varImp(rfit_all))
```

```{r, rtree least}

rfit_least <- train(rentals ~ season + humidity + weather, data = bikeTrain1,
                  method = "rpart", preProcess = 
                  c("center", "scale"), trControl = 
                  trainControl(method = "LOOCV"))
rfit_least$results
```

```{r, rtree top}

rfit_top <- train(rentals ~ temp + humidity + hour, data = bikeTrain1,
                         method = "rpart", preProcess = 
                         c("center", "scale"), trControl = 
                         trainControl(method = "LOOCV"))
                         
rfit_top$results[, c(1,2)]
```

```{r, rtre top tuned}
tune <- c(0, .05, .01, .015, .02)
 
# Train system tuned CP
ufit_topTuned <- train(rentals ~ temp + humidity + hour, data = bikeTrain1,
                         method = "rpart", preProcess = 
                         c("center", "scale"), trControl = 
                         trainControl(method = "LOOCV"),
                         tuneGrid = expand.grid(cp = tune))

ufit_topTuned$results[, c(1,2)]
```

```{r, rtree final model}

ufit_fin <- train(rentals ~ temp + humidity + hour, data = bikeTrain1,
                         method = "rpart", 
                         preProcess = c("center", "scale"),
                         trControl = trainControl(method = "LOOCV"), 
                         tuneGrid = expand.grid(cp = .02))
ufit_fin$results
plot(ufit_fin$finalModel)
text(ufit_fin$finalModel, pretty = 1, cex = .8)

```


```{r, rtree final predict}
rt_pred <- predict(ufit_fin, newdata = bikeTest1)
rt_predResults <- as_tibble(postResample(tree_pred, bikeTest1$rentals))
setattr(rt_predResults, "row.names", c("RMSE", "R-squared", "MAE"))
kable(rt_predResults, caption = "Regression Tree Fit Results")
```
